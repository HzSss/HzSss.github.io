<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    weak原理探索 | Acan_Dev
  </title>
  <meta name="description" content="You only live once">
  
  <meta name="keywords" content="
  iOS
  ">
  
  <meta name="author" content="Acan_Dev">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars0.githubusercontent.com/u/27425237?s=460&amp;v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 20 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 5 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 0 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">Acan_Dev</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    Acan_Dev

    <span class="post-date float-right" title="{{moment(1529049408000).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1529049408000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>weak原理探索</h1>
    <h3 id="weak-指针"><a href="#weak-指针" class="headerlink" title="weak 指针"></a>weak 指针</h3><p>weak是弱引用，所引用对象的计数器不会加一，并在引用对象被释放的时候自动被设置为nil。通常用于解决循环引用问题。</p>
<h3 id="weak-表"><a href="#weak-表" class="headerlink" title="weak 表"></a>weak 表</h3><p>runtime 维护了一个 weak 表，用于存储指向某个对象的所有 weak 指针。weak 表是一个 hash 表：<br><img src="https://upload-images.jianshu.io/upload_images/6365912-7bca92ed1c76841e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="weak 表"></p>
<h3 id="weak-实现原理"><a href="#weak-实现原理" class="headerlink" title="weak 实现原理"></a>weak 实现原理</h3><h5 id="1、初始化时：runtime-会调用-objc-initWeak-函数，objc-initWeak-函数会初始化一个新的-weak-指针指向对象的地址。"><a href="#1、初始化时：runtime-会调用-objc-initWeak-函数，objc-initWeak-函数会初始化一个新的-weak-指针指向对象的地址。" class="headerlink" title="1、初始化时：runtime 会调用 objc_initWeak() 函数，objc_initWeak() 函数会初始化一个新的 weak 指针指向对象的地址。"></a>1、初始化时：runtime 会调用 objc_initWeak() 函数，objc_initWeak() 函数会初始化一个新的 weak 指针指向对象的地址。</h5><pre><code>// object 是要初始化的指针，value 是指针指向的对象
id objc_initWeak(id *object, id value);
</code></pre><p>objc_initWeak() 方法的实现如下：</p>
<pre><code>id objc_initWeak(id *location, id newObj) {
  // 查看对象实例是否有效
  // 无效对象直接导致指针释放
  if (!newObj) {
    *location = nil;
    return nil;
  }
  // 这里传递了三个 bool 数值
  // 使用 template 进行常量参数传递是为了优化性能
  return storeWeakfalse/*old*/, true/*new*/, true/*crash*/&gt;
  (location, (objc_object*)newObj);
}
</code></pre><p>这里判断了其指针指向的对象是否有效，无效则直接释放，不再往调用深层函数。若有效，则调用 objc_storeWeak() 函数，要被初始化的指针（object）将被注册为一个指向对象（value）的 __weak 指针对象。</p>
<blockquote>
<p>objc_initWeak() 函数有一个前提条件：就是 object 必须是一个没有被注册为__weak 对象的有效指针。而 value 则可以是 null，或者指向一个有效的对象。</p>
</blockquote>
<h5 id="2、添加引用时：objc-initWeak-函数会调用-objc-storeWeak-函数，-objc-storeWeak-的作用是更新指针指向，创建对应的弱引用表。"><a href="#2、添加引用时：objc-initWeak-函数会调用-objc-storeWeak-函数，-objc-storeWeak-的作用是更新指针指向，创建对应的弱引用表。" class="headerlink" title="2、添加引用时：objc_initWeak() 函数会调用 objc_storeWeak() 函数， objc_storeWeak() 的作用是更新指针指向，创建对应的弱引用表。"></a>2、添加引用时：objc_initWeak() 函数会调用 objc_storeWeak() 函数， objc_storeWeak() 的作用是更新指针指向，创建对应的弱引用表。</h5><pre><code>id objc_storeWeak(id *location, id value);
</code></pre><p>1）创建 weak 弱引用表<br>2）解除旧对象的弱引用表<br>3）将新的弱引用表与对象进行关联绑定</p>
<p><img src="https://upload-images.jianshu.io/upload_images/6365912-be5dc3924e9a8e0d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="初始化弱引用对象流程"></p>
<h5 id="3、释放时，调用-clearDeallocating-函数。clearDeallocating-函数首先根据对象地址获取所有-weak-指针地址的数组，然后遍历这个数组把其中的数据设为-nil，最后把这个-entry-从-weak-表中删除，最后清理对象的记录。"><a href="#3、释放时，调用-clearDeallocating-函数。clearDeallocating-函数首先根据对象地址获取所有-weak-指针地址的数组，然后遍历这个数组把其中的数据设为-nil，最后把这个-entry-从-weak-表中删除，最后清理对象的记录。" class="headerlink" title="3、释放时，调用 clearDeallocating 函数。clearDeallocating 函数首先根据对象地址获取所有 weak 指针地址的数组，然后遍历这个数组把其中的数据设为 nil，最后把这个 entry 从 weak 表中删除，最后清理对象的记录。"></a>3、释放时，调用 clearDeallocating 函数。clearDeallocating 函数首先根据对象地址获取所有 weak 指针地址的数组，然后遍历这个数组把其中的数据设为 nil，最后把这个 entry 从 weak 表中删除，最后清理对象的记录。</h5>
  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://github.com/hzsss" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2018 Acan_Dev</li>
      <li><a href="https://github.com/hzsss">Home</a></li>
      
      <li><a href="https://github.com/hzsss">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
